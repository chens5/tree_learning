This is the GitHub repository for the paper ["Learning Ultrametric Trees for Optimal Transport Regression" (Sam Chen, Puoya Tabaghi, Yusu Wang, 2022)](https://arxiv.org/abs/2210.12288). Here, we present a projected gradient descent algorithm to learn tree structure and metric using ultrametrics as a proxy. The learned tree structure is then used for fast and accurate computations of optimal transport for probability measures in discrete metric spaces. In a nutshell, we first embed the original discrete metric space into a ultrametric via a hierarchical minimum spanning tree procedure and then adjust the resulting ultrametric matrix via gradient descent. The resulting matrix is embedded back to ultrametric space again through MST. 

## Details
Running the code requires: numpy, torch, Python OT (POT), scipy, cython, and sklearn.

The learned tree structure can be found in the file `ot_tree.py`. Note that in the ultrametric matrix, we only optimize 2n-1 variables. This is because in the ultrametric tree there are only 2n-1 total edges which contribute to the distance between nodes so entries in the matrix can be "tied" together when performing gradient descent on the tree. Using this fact helps in three ways: (1) optimizing each entry of the matrix individually can often lead to numerical instabilities as the adjusted entries end up not being using the projection procedure, (2) helps resolve the issue of multiple optimal flows on the tree (when computing optimal transport between measures defined on the nodes of the tree) and (3) speeds training of the tree. 